# 生成函数
_原稿：数学/讲义/生成函数讲稿.md | 2021/12/19 | 吕欣老师_

生成函数（在数学上叫母函数）是解决组合问题和数列问题的强大武器。其实高中数学所用的特征根等方法已是生成函数，但不是完全意义上的生成函数。真正的生成函数极为复杂，并且要求有强大的数学运算能力和夯实的多项式基础。

##### 常见的等式结论
1. **$\sum x^i =  \frac 1 {1-x}$**
    > 由 $\sum_{i=0}^n = \frac {1-x^n} {1-x}$ 得, $\lim_{n \to +\infty}$ 时， $\sum_{i=0}^{n} x^i = \frac 1 {1-x}$。

2. **$\sum_{i=1}^{+\infty} \frac {x^i} i = -ln(1-x)$**
    > 令 $f(x) = \sum_{i=1}^{+\infty} \frac {x^i} i$，那么 $f'(x) = \sum_{i=0}^{+\infty} x^i$。 由 (1) 知， $f'(x) = \frac 1 {1-x}$。于是 $f(x) = \int f'(x) = -ln(1-x)$   。

3. **$f(x) = \sum_{i=0}^n (x-x_0)^i \frac { f^{(i)}(x_0) } {i!}$，其中 $x_0 \in R, n \in N^+$**
    > 大名鼎鼎的泰勒展开式，当 $n\to +\infty$时，两边全部拟合。

4. **$\sum_{i=0} \frac {x^i} {i!} = e^x$**
    > 由 (3) 知， 当 $x_0 = 0$ 时，$e^x = \sum (x-0)^i \frac {e^0} {i!} = \sum \frac {x^i} {i!}$


### 普通生成函数

假设一个数列 $\{f\}$，那么这个数列可以与一个多项式函数 $F(x)=\sum f_i x^i$ 相对应。这个 $F(x)$ 定义为 $\{f\}$ 的生成函数。  
若 $\{f_i\}$ 代表规模为 $i$ 的组合问题，$F(x)$ 为 $\{f_i\}$ 的生成函数，那么 $F(x)$ 的一些运算是有组合意义的：   
* $F(x)+G(x) = \sum (f_i + g_i) x^i$ ：$i$ 个元素组成 $f$ 结构**或**组成 $g$ 结构的方案数  
* $F(x)G(x) = \sum_i ( \sum_{j+k=i} f_kg_j ) x^i$ : $i$ 个元素组成一个 $f$ **和** 一个 $g$ 结构的方案数。注意这里 $n$ 个单位中哪 $i$ 个单位构成一个 $f$-结构**并不重要**，也就是说，每一个单位是**无标号**的。

##### 生成序列
假设我们要计算组成 $g$-结构的方案数，每个 $g$-结构由若干个 $f$-结构**有序**组成，那么:
$$ G(x) = \sum_{i=0}^{+\infty} F^k(x) = \frac 1 {1 - F(x)} \qquad 结论(1)$$
需要注意的是，这里要求有 $f_0 = 0$， 否则一个 $g$-结构有无限种方案。

##### 生成集合
现在要计算组成 $g$-结构的方案数，每个 $g$-结构由若干个 $f$-结构**无序**组成。这里仍然要求 $f_0=0$，否则任意大小 $g$-结构仍然会具有无穷种方案。  
首先有一种错误的做法，直接 $\frac {F(x)^k} {k!}$ 就得到了包含 $k$ 个 $f$-结构的方案数。但其实这是一种错误的解法，会导致答案偏小。比如一种情况 $2,2,4$ 会在生成排列时被计算 $3$ 次， 而不是 $3!=6$ 次。  
正确的推导应该是枚举每个规模的 $f$-结构在目标的 $g$-结构中出现了多少次。具体的，若有一个规模为 $i$ 的 $f$-结构，那么它在 $g$-结构中的出现次数可以用以下临时生成函数表示：
$$ H_i(x)  =  (x^0 + x^i + x^{2i} + \cdots ) ^ {f_i}  =  (\frac 1 {1-x^i}) ^ {f_i} \qquad 结论(1)$$  
并且 $g$-结构可以选择任意规模的 $f$-结构组成，于是:
$$ G(x) = \prod_{i=0} H_i(x) = \prod_{i=0} (\frac 1 {1-x^i}) ^ {f_i}$$  
然后可以对 $G(x)$ 使用 ln-then-exp 技巧：
$$ \begin{aligned}
\ln(G(x)) &= \sum_{i=0} f_i （ - \ln( 1-x^i ) ） \\
         &= \sum_{i=0} f_i \sum_{j=0} \frac {x^{ij}} j &结论(2)\\
         &= \sum_{i=0} \frac 1 j \sum_{i=0} f_i x^{ij} \\
         &= \sum_{i=0} \frac 1 j F(x^j) \\
\therefore G(x) &= e^{\sum_{i=0} \frac 1 j F(x^j)} \\
\end {aligned}$$  



### 指数生成函数

对于一个数列 $\{f_i\}$, 我们定义它的指数生成函数是 $F(x) = \sum_i f_i \frac {x^i} {i!}$。现在尝试定义一下指数生成函数的加乘运算：  
* $F(x) + G(x) = \sum (f_i + g_i) \frac {x^i} {i!}$： 组合意义仍然是构成一个 $f$-结构**或者**构成一个 $g$-结构的方案数。  
* $F(x)G(x) = \sum ( \sum_j \frac {f_j} {j!} \frac {g_{i-j}} {(i-j)!} ) \frac {x^i} {i!}$ 乘法运算的组合意义仍是构成一个 $f$-结构**和**一个 $g$-结构的方案数。观察结果中 $x^n$ 的系数：  
 $[x^n] ( F(x)G(x) ) = n! \sum_j \frac {f_i} {i!} \frac {g_{n-i}} {(n-i)!} = C_n^i f_i g_{n-i}$   
 这个多出来的 $C_n^i$ 代表了从结果中规模为 $n$ 的结构中**选择**出 $i$ 个组成 $f$-结构，其余组成 $g$-结构。这意味着每一个单位是**有标号**的。

##### 生成序列
生成序列表示把 $n$ 个单位分成有差异的任意多组，那么照样有：  
$$G(x) = \sum F(x) ^ k = \frac 1 {1-F(x)} \qquad 结论(1)$$  
同样要求 $f_0 = 0$.

##### 生成集合
指数型生成函数的生成集合比普通生成函数的要简单不少。在普通生成函数中的生成集合一节中，介绍了一个错误的解法，即 $G(x) \not= \sum \frac {F(x)^k} {k!}$，因为类似 $\{f_1, f_2, f_2\}$ 的集合只会被计算 $3$ 次。但是在指数型生成函数中，每一个基本单位之间都是互不相同的，这导致两个 $f_2$ 在实际中是不同的，因此这一钟方案也会被计算 $6$ 次。因此可以直接得到 $G(x)$：
$$ G(x) = \sum \frac {F(x)^k} {k!} = e^{F(x)} \qquad 结论4$$


| EGF(生成函数) | 元素间有无差异 | 分组间是否有差异 |            结论             |
| :----------: | :-----------: | :-------------: | :------------------------: |
| 普通生成序列  |       无      |        有       |     $\frac 1 {1-F(x)}$      |
| 普通生成集合  |       无      |        有       | $e^{\sum \frac 1 i F(x)^i}$ |
| 指数生成序列  |       有      |        有       |     $\frac 1 {1-F(x)}$      |
| 指数生成集合  |       有      |        无       | $e^{F(x)}$                  |


-----------


##### [P4841 城市规划](https://www.luogu.com.cn/problem/P4841)
**题意**  
求 $n$ 个点连通的无向图个数  
**解法**   
首先令 $g$ 表示没有连通限制的无向图计数，$f$ 表示答案，设 $G(x)$ 为 $g$ 的指数型生成函数，考虑使用 $G(x)$ 推出 $F(x)$，枚举几个连通块：
$$  
F(x) = \sum \frac {G^i(x)} {i!} = e^{G(x)} \\
\therefore F(x) = \ln G(x)
$$


##### [P4451 [国家集训队]整数的lqp拆分](https://www.luogu.com.cn/problem/P4451)
**题意**  
求 $\sum_{\sum a_i = m} ( \prod f_{a_i} )$，$\{f_i\}$ 表示fibbonaci数列  
**解法**  
令 $\{g_i\}$ 表示答案序列，那么显然有递推：
$$
g_n = \begin{cases} \sum_{i=0}^n f_i g_{n-i} & x \neq  0 \\
                    1&       n=0 \\
      \end{cases}
$$
于是生成函数它们的普通生成函数 $F(x)$ $G(x)$ 间有以下关系：
$$ G(x) = G(x)F(x) + 1 $$
因此 $g_n = \frac {\sqrt 2} 4 [ (1+ \sqrt 2)^n - (1 - \sqrt 2)^n ]$   
